<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Data Pre-processor - Rapid Capital</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        function CSVProcessor() {
          const [data, setData] = useState(null);
          const [processedData, setProcessedData] = useState(null);
          const [errors, setErrors] = useState([]);
          const [fileName, setFileName] = useState('');

          const transliterateToDevanagari = (text) => {
            const romanToDevanagariMap = {
              'a': 'अ', 'b': 'ब', 'c': 'च', 'd': 'द', 'e': 'ए', 'f': 'फ', 'g': 'ग',
              'h': 'ह', 'i': 'इ', 'j': 'ज', 'k': 'क', 'l': 'ल', 'm': 'म', 'n': 'न',
              'o': 'ओ', 'p': 'प', 'q': 'क्व', 'r': 'र', 's': 'स', 't': 'त', 'u': 'उ',
              'v': 'व', 'w': 'व', 'x': 'क्स', 'y': 'य', 'z': 'ज'
            };
            return text.split('').map(char => 
              romanToDevanagariMap[char.toLowerCase()] || char
            ).join('');
          };

          const numberToWordsHindi = (num) => {
            const n = Math.floor(parseFloat(num));
            if (n === 0) return 'शून्य';
            if (n < 0) return 'ऋण ' + numberToWordsHindi(Math.abs(n));
            
            const ones = ['', 'एक', 'दो', 'तीन', 'चार', 'पांच', 'छः', 'सात', 'आठ', 'नौ'];
            const tens = ['', 'दस', 'बीस', 'तीस', 'चालीस', 'पचास', 'साठ', 'सत्तर', 'अस्सी', 'नब्बे'];
            const teens = ['दस', 'ग्यारह', 'बारह', 'तेरह', 'चौदह', 'पंद्रह', 'सोलह', 'सत्रह', 'अठारह', 'उन्नीस'];
            
            if (n < 10) return ones[n];
            if (n >= 10 && n < 20) return teens[n - 10];
            if (n >= 20 && n < 100) {
              const ten = Math.floor(n / 10);
              const one = n % 10;
              return tens[ten] + (one > 0 ? ' ' + ones[one] : '');
            }
            if (n >= 100 && n < 1000) {
              const hundred = Math.floor(n / 100);
              const remainder = n % 100;
              return ones[hundred] + ' सौ' + (remainder > 0 ? ' ' + numberToWordsHindi(remainder) : '');
            }
            if (n >= 1000 && n < 100000) {
              const thousand = Math.floor(n / 1000);
              const remainder = n % 1000;
              return numberToWordsHindi(thousand) + ' हजार' + (remainder > 0 ? ' ' + numberToWordsHindi(remainder) : '');
            }
            if (n >= 100000 && n < 10000000) {
              const lakh = Math.floor(n / 100000);
              const remainder = n % 100000;
              return numberToWordsHindi(lakh) + ' लाख' + (remainder > 0 ? ' ' + numberToWordsHindi(remainder) : '');
            }
            if (n >= 10000000) {
              const crore = Math.floor(n / 10000000);
              const remainder = n % 10000000;
              return numberToWordsHindi(crore) + ' करोड़' + (remainder > 0 ? ' ' + numberToWordsHindi(remainder) : '');
            }
            return String(n);
          };

          const numberToWordsEnglish = (num) => {
            const n = Math.floor(parseFloat(num));
            if (n === 0) return 'Zero';
            if (n < 0) return 'Minus ' + numberToWordsEnglish(Math.abs(n));
            
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const tens = ['', 'Ten', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            
            if (n < 10) return ones[n];
            if (n >= 10 && n < 20) return teens[n - 10];
            if (n >= 20 && n < 100) {
              const ten = Math.floor(n / 10);
              const one = n % 10;
              return tens[ten] + (one > 0 ? ' ' + ones[one] : '');
            }
            if (n >= 100 && n < 1000) {
              const hundred = Math.floor(n / 100);
              const remainder = n % 100;
              return ones[hundred] + ' Hundred' + (remainder > 0 ? ' ' + numberToWordsEnglish(remainder) : '');
            }
            if (n >= 1000 && n < 100000) {
              const thousand = Math.floor(n / 1000);
              const remainder = n % 1000;
              return numberToWordsEnglish(thousand) + ' Thousand' + (remainder > 0 ? ' ' + numberToWordsEnglish(remainder) : '');
            }
            if (n >= 100000 && n < 10000000) {
              const lakh = Math.floor(n / 100000);
              const remainder = n % 100000;
              return numberToWordsEnglish(lakh) + ' Lakh' + (remainder > 0 ? ' ' + numberToWordsEnglish(remainder) : '');
            }
            if (n >= 10000000) {
              const crore = Math.floor(n / 10000000);
              const remainder = n % 10000000;
              return numberToWordsEnglish(crore) + ' Crore' + (remainder > 0 ? ' ' + numberToWordsEnglish(remainder) : '');
            }
            return String(n);
          };

          const formatDateAsWords = (dateStr) => {
            try {
              const date = new Date(dateStr);
              if (isNaN(date)) return dateStr;
              
              const months = ['January', 'February', 'March', 'April', 'May', 'June',
                             'July', 'August', 'September', 'October', 'November', 'December'];
              const day = date.getDate();
              const month = months[date.getMonth()];
              const year = date.getFullYear();
              
              return `${day} ${month} ${year}`;
            } catch (e) {
              return dateStr;
            }
          };

          const validatePhoneNumber = (phone) => {
            const cleaned = String(phone).replace(/\D/g, '');
            return cleaned.length === 10 ? cleaned : null;
          };

          const handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            setFileName(file.name);
            Papa.parse(file, {
              header: true,
              skipEmptyLines: true,
              complete: (results) => {
                setData(results.data);
                processData(results.data);
              },
              error: (error) => {
                setErrors([`CSV parsing error: ${error.message}`]);
              }
            });
          };

          const processData = (rawData) => {
            const newErrors = [];
            const validRows = [];
            const invalidRows = [];

            rawData.forEach((row, rowIdx) => {
              const newRow = {};
              let hasValidPhone = false;
              let phoneValue = null;

              // First pass: Find and validate phone number
              Object.keys(row).forEach(col => {
                const value = row[col];

                if (col.toLowerCase().includes('phone') || col.toLowerCase().includes('mobile')) {
                  const validated = validatePhoneNumber(value);
                  if (validated) {
                    phoneValue = validated;
                    hasValidPhone = true;
                  } else if (value) {
                    newErrors.push(`Row ${rowIdx + 1}: Phone number "${value}" is not 10 digits - ROW EXCLUDED`);
                  }
                }
              });

              // Only process rows with valid phone numbers
              if (hasValidPhone) {
                // Add phone number first (with space)
                newRow['phone number'] = phoneValue;

                // Second pass: Process all other columns
                Object.keys(row).forEach(col => {
                  const value = row[col];

                  // Skip phone/mobile columns as we already handled them
                  if (col.toLowerCase().includes('phone') || col.toLowerCase().includes('mobile')) {
                    return;
                  }

                  // Add other columns as-is
                  newRow[col] = value;

                  // Operation 2: Name transliteration
                  if (col.toLowerCase().includes('name') && value) {
                    newRow['name_devnagari'] = transliterateToDevanagari(value);
                  }

                  // Operation 3: Score/Amount conversion
                  if ((col.toLowerCase().includes('score') || col.toLowerCase().includes('amount')) && value) {
                    const numVal = parseFloat(value);
                    if (!isNaN(numVal)) {
                      newRow[`${col}_words_hi`] = numberToWordsHindi(numVal);
                      newRow[`${col}_words_en`] = numberToWordsEnglish(numVal);
                    }
                  }

                  // Operation 4: Date formatting
                  if (col.toLowerCase().includes('date') && value) {
                    newRow['date_formatted'] = formatDateAsWords(value);
                  }
                });

                validRows.push(newRow);
              } else {
                invalidRows.push(row);
              }
            });

            setProcessedData(validRows);
            setErrors(newErrors);
          };

          const downloadProcessedCSV = () => {
            if (!processedData || processedData.length === 0) return;

            const csv = Papa.unparse(processedData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `processed_${fileName}`;
            a.click();
            window.URL.revokeObjectURL(url);
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
              <div className="max-w-6xl mx-auto">
                <div className="bg-white rounded-lg shadow-lg p-8">
                  <h1 className="text-3xl font-bold text-gray-800 mb-2">CSV Data Pre-processor</h1>
                  <p className="text-gray-600 mb-8">For Rapid Capital AI Agent - Tamil Calling</p>

                  <div className="mb-8">
                    <label className="flex items-center justify-center w-full px-4 py-6 bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer hover:bg-blue-100 transition">
                      <div className="flex flex-col items-center justify-center">
                        <svg className="w-8 h-8 text-blue-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span className="text-lg font-semibold text-blue-600">Upload CSV File</span>
                        <span className="text-sm text-gray-500 mt-1">Click to select or drag and drop</span>
                      </div>
                      <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                    </label>
                  </div>

                  {errors.length > 0 && (
                    <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                      <div className="flex items-start">
                        <svg className="w-5 h-5 text-red-600 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                          <h3 className="font-semibold text-red-800 mb-2">Validation Issues</h3>
                          <ul className="text-sm text-red-700 space-y-1">
                            {errors.map((err, i) => <li key={i}>• {err}</li>)}
                          </ul>
                        </div>
                      </div>
                    </div>
                  )}

                  {processedData && (
                    <>
                      <div className="mb-8 bg-green-50 border border-green-200 rounded-lg p-4">
                        <div className="flex items-center mb-4">
                          <svg className="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          <h3 className="font-semibold text-green-800">Processing Complete</h3>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                          <div>
                            <p className="text-gray-600">Valid Rows (Included)</p>
                            <p className="text-lg font-bold text-green-700">{processedData.length}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Invalid Rows (Excluded)</p>
                            <p className="text-lg font-bold text-red-700">{errors.length}</p>
                          </div>
                          <div>
                            <p className="text-gray-600">Total Columns</p>
                            <p className="text-lg font-bold text-green-700">{Object.keys(processedData[0] || {}).length}</p>
                          </div>
                        </div>
                      </div>

                      <div className="mb-8">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">Data Preview (First 3 Rows)</h3>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm border-collapse">
                            <thead>
                              <tr className="bg-gray-100">
                                {Object.keys(processedData[0]).map((col, i) => (
                                  <th key={i} className="border border-gray-300 px-3 py-2 text-left font-semibold text-gray-700">
                                    {col}
                                  </th>
                                ))}
                              </tr>
                            </thead>
                            <tbody>
                              {processedData.slice(0, 3).map((row, i) => (
                                <tr key={i} className={i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                  {Object.values(row).map((val, j) => (
                                    <td key={j} className="border border-gray-300 px-3 py-2 text-gray-700">
                                      {String(val).substring(0, 30)}
                                    </td>
                                  ))}
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <button
                        onClick={downloadProcessedCSV}
                        className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download Processed CSV
                      </button>
                    </>
                  )}
                </div>

                <div className="mt-8 bg-white rounded-lg shadow-lg p-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">What This Tool Does</h2>
                  <ul className="space-y-3 text-gray-700">
                    <li className="flex items-start">
                      <svg className="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                      </svg>
                      <span><strong>Operation 1:</strong> Validates phone numbers (must be 10 digits) and renames column to <code className="bg-gray-100 px-2 py-1 rounded">phone number</code>. Invalid rows are excluded.</span>
                    </li>
                    <li className="flex items-start">
                      <svg className="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                      </svg>
                      <span><strong>Operation 2:</strong> Transliterates names to Devanagari script (creates <code className="bg-gray-100 px-2 py-1 rounded">name_devnagari</code> column)</span>
                    </li>
                    <li className="flex items-start">
                      <svg className="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                      </svg>
                      <span><strong>Operation 3:</strong> Converts amounts/scores to words in Hindi and English</span>
                    </li>
                    <li className="flex items-start">
                      <svg className="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                      </svg>
                      <span><strong>Operation 4:</strong> Formats dates as readable text (creates <code className="bg-gray-100 px-2 py-1 rounded">date_formatted</code> column)</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CSVProcessor />);
    </script>
</body>
</html>
